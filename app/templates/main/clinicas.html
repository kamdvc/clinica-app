{% extends 'main/base.html' %}

{% block title %}Estado de Clínicas{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Estado de Clínicas</h1>
        {% if current_user.rol in ['medico', 'medico_supervisor'] %}
        <div class="alert alert-info mb-0">
            <i class="fas fa-info-circle"></i> 
            {% if current_user.clinica_actual %}
            Estás atendiendo en {{ current_user.clinica_actual.nombre }}
            {% else %}
            No estás asignado a ninguna clínica actualmente
            {% endif %}
        </div>
        {% endif %}
    </div>
    
    {% if paciente_en_espera %}
    <div class="alert alert-warning mb-4">
        <i class="fas fa-user-clock"></i> 
        Paciente en espera: {{ paciente_en_espera.nombre_completo }}
    </div>
    {% endif %}
    
    <div class="row">
        {% for clinica in clinicas %}
        <div class="col-md-6 mb-4">
            <div class="card h-100 {% if current_user.clinica_actual_id == clinica.id %}border-primary border-3{% endif %}">
                <div class="card-header {% if clinica.disponible %}bg-success{% else %}bg-danger{% endif %} text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ clinica.nombre }}</h5>
                    <div>
                        {% if current_user.clinica_actual_id == clinica.id %}
                        <span class="badge bg-warning text-dark me-2">
                            <i class="fas fa-user-md"></i> Tu clínica actual
                        </span>
                        {% endif %}
                        <span class="badge bg-light text-dark">
                            {% if clinica.disponible %}
                                <i class="fas fa-check-circle text-success"></i> DISPONIBLE
                            {% else %}
                                <i class="fas fa-times-circle text-danger"></i> NO DISPONIBLE
                            {% endif %}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Estado actual:</h6>
                        {% if clinica.disponible %}
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i> Esta clínica está disponible para atender pacientes
                            </div>
                        {% else %}
                            <div class="alert alert-danger">
                                <i class="fas fa-times-circle"></i> Esta clínica no está disponible en este momento
                                {% if current_user.clinica_actual_id == clinica.id %}
                                <br>
                                <small><i class="fas fa-info-circle"></i> Estás atendiendo en esta clínica</small>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                    {% if current_user.rol in ['medico', 'medico_supervisor'] %}
                    <form method="post" action="{{ url_for('main.actualizar_estado_clinica', clinica_id=clinica.id) }}" class="text-center">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="estado" value="{% if clinica.disponible %}0{% else %}1{% endif %}">
                        {% if paciente_en_espera %}
                        <input type="hidden" name="paciente_id" value="{{ paciente_en_espera.id }}">
                        {% endif %}
                        <button type="submit" class="btn {% if clinica.disponible %}btn-danger{% else %}btn-success{% endif %} {% if current_user.clinica_actual_id == clinica.id %}btn-lg w-100{% endif %}">
                            {% if clinica.disponible %}
                                {% if not current_user.clinica_actual_id %}
                                    {% if paciente_en_espera %}
                                        Atender a {{ paciente_en_espera.nombre_completo }}
                                    {% else %}
                                        Atender en esta clínica
                                    {% endif %}
                                {% else %}
                                    Marcar como No Disponible
                                {% endif %}
                            {% else %}
                                {% if current_user.clinica_actual_id == clinica.id %}
                                    Liberar esta clínica
                                {% else %}
                                    Marcar como Disponible
                                {% endif %}
                            {% endif %}
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}