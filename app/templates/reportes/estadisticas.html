{% extends 'main/base.html' %}

{% block title %}Estadísticas Clínicas - Sistema Clínico{% endblock %}

{% block content %}
<div class="container-fluid" id="report-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Estadísticas Clínicas</h1>
        <div class="btn-group">
            <button class="btn btn-primary d-print-none" onclick="window.print()"><i class="fas fa-print"></i> Imprimir</button>
            <a href="{{ url_for('main.exportar_reportes_pdf') }}" class="btn btn-success d-print-none"><i class="fas fa-file-pdf"></i> Exportar PDF</a>
        </div>
    </div>

    <!-- Distribución por Género y Edad -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Distribución por Género</h5>
                </div>
                <div class="card-body">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Rango de Edades</h5>
                </div>
                <div class="card-body">
                    <canvas id="ageChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Enfermedades Atendidas -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Enfermedades Más Comunes</h5>
        </div>
        <div class="card-body">
            <canvas id="diseasesChart"></canvas>
        </div>
    </div>

    <!-- Problemas por Sistemas -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Problemas por Sistemas</h5>
        </div>
        <div class="card-body">
            <canvas id="systemsChart"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Gráfico de Género
        const genderCtx = document.getElementById('genderChart');
        if (genderCtx) {
            new Chart(genderCtx.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['Masculino', 'Femenino'],
                    datasets: [{
                        data: [{{ masculino or 0 }}, {{ femenino or 0 }}],
                        backgroundColor: ['#36A2EB', '#FF6384']
                    }]
                }
            });
        }

        // Gráfico de Edades
        const ageCtx = document.getElementById('ageChart');
        if (ageCtx) {
            new Chart(ageCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: {{ rangos_edad | tojson | safe }},
                    datasets: [{
                        label: 'Pacientes',
                        data: {{ conteo_edades | tojson | safe }},
                        backgroundColor: '#36A2EB'
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Gráfico de Enfermedades
        const diseasesCtx = document.getElementById('diseasesChart');
        if (diseasesCtx) {
            new Chart(diseasesCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: {{ enfermedades_labels | tojson | safe }},
                    datasets: [{
                        label: 'Casos',
                        data: {{ enfermedades_casos | tojson | safe }},
                        backgroundColor: '#4BC0C0'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: { x: { beginAtZero: true } }
                }
            });
        }

        // Gráfico de Problemas por Sistemas
        const systemsCtx = document.getElementById('systemsChart');
        if (systemsCtx && {{ sistemas_labels | length > 0 }}) {
            new Chart(systemsCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: {{ sistemas_labels | tojson | safe }},
                    datasets: [{
                        label: 'Menciones',
                        data: {{ sistemas_casos | tojson | safe }},
                        backgroundColor: '#FF9F40'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: { x: { beginAtZero: true } }
                }
            });
        } else if (systemsCtx) {
            const p = document.createElement('p');
            p.textContent = 'No hay suficientes datos para mostrar el reporte por sistemas.';
            systemsCtx.parentElement.append(p);
        }
    });
</script>
{% endblock %}
